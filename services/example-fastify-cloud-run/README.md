# Fastify Cloud Run

## Overview

This is an example service that uses fastify to expose a web server through Google Cloud Run.

## Environments

This service has 3 environments:

- dev: The local development environment
- stg: The deployed staging environment
- prd: The deployed production environment

Each environment has a configuration setup in Doppler for this project. You can visit this project's Doppler config to see the latest required configuration for each environment.

**Always manage all your environment variables and secrets in Doppler**

## Deployment

This service is deployed to Google Cloud Run via Github Actions. The deployment process is as follows:

1. Any changes along with a changeset is committed to a feature PR
2. The feature PR is merged to main
3. Github Actions generates a "Version Packages" PR to bump all package versions
4. The "Version Packages" PR is merged to main
5. Any associated libraries are published to Github Package Registry
6. A release/staging-x.x.x PR is generated by Github Actions
7. The release/staging-x.x.x PR is merged to main
8. The `deploy-services-stg.yml` Github Action queues a build in Google Cloud Build
9. A release/production-x.x.x PR is generated by Github Actions
10. The release/production-x.x.x PR is merged to main
11. The `deploy-services-prd.yml` Github Action queues a build in Google Cloud Build

## Configuration

The services' deployment configuration lives within `env-config.mjs`. **_In order to trigger a build this config must have an entry for that environment_**. The file should have a typecheck annotation to help guide you on what fields are required.

The Doppler configuration for this project is synced to Google Cloud Secret Manager with the secret keys: `stg_example-fastify-cloud-run` and `prd_example-fastify-cloud-run`. These can be observed in the `env-config.mjs`.
